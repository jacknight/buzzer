<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="stylesheet" type="text/css" href="select-css.css" />

    <title>Buzzer Controls</title>
  </head>
  <body>
    <div class="layout">
      <a
        class="login-link"
        style="display: none; text-align: center"
        href="https://discord.com/api/oauth2/authorize?client_id=789204496097214514&redirect_uri=https%3A%2F%2Fdiscord-buzzer.herokuapp.com&response_type=token&scope=identify"
        >Login</a
      >
      <div class="control-panel" style="display: none">
        <img src="assets/yks-logo.webp" />
        <div class="buzz-queue">
          <div class="buzz-list">
            <h1>Dookie List</h1>
            <ol></ol>
          </div>
          <button name="random" disabled>Random</button>
          <button name="clear" disabled>Clear</button>
        </div>
        <div class="buzz-controls">
          <button name="mode" disabled>Mode</button>
          <p id="mode">-</p>
          <button name="ready" disabled>&#10004;</button>
          <p id="ready">-</p>
        </div>
        <div class="buzz-servers" hidden>
          <select name="servers" id="servers" class="select-css">
            <option value="">Choose a server</option>
          </select>
        </div>
        <div class="buzz-channels" hidden>
          <select name="channels" id="channels" class="select-css"></select>
          <button name="channelSelect" id="channelSelect" disabled>
            Listen
          </button>
        </div>
      </div>
      <a
        class="bot-link"
        style="display: grid; text-align: center"
        target="_blank"
        href="https://discord.com/api/oauth2/authorize?client_id=789204496097214514&permissions=67128384&redirect_uri=https%3A%2F%2Fdiscord-buzzer.herokuapp.com&scope=bot"
        >Add ðŸ¤– to Server</a
      >
    </div>
    <script src="node_modules/socket.io/client-dist/socket.io.js"></script>
    <script src="client.js"></script>
    <script>
      window.onload = () => {
        const fragment = new URLSearchParams(window.location.hash.slice(1));

        if (fragment.has("access_token")) {
          const accessToken = fragment.get("access_token");
          const tokenType = fragment.get("token_type");
          localStorage.setItem("tokenType", tokenType);
          localStorage.setItem("accessToken", accessToken);

          fetch("https://discord.com/api/users/@me", {
            headers: {
              authorization: `${tokenType} ${accessToken}`,
            },
          })
            .then((res) => res.json())
            .then((response) => {
              const { username, discriminator, id } = response;
              localStorage.setItem("user_id", id);
              localStorage.setItem("user_name", username);
              localStorage.setItem("discriminator", discriminator);
            })
            .catch(console.error)
            .then(
              fetch("https://discord.com/api/users/@me/guilds", {
                headers: {
                  authorization: `${tokenType} ${accessToken}`,
                },
              })
                .then((res) => res.json())
                .then((response) => {
                  requestServers();
                  populateServersSelect(response);
                  document.querySelector(".control-panel").style.display =
                    "grid";
                })
                .catch(console.error)
            );
        } else {
          document.querySelector(".login-link").style.display = " block";
        }
      };

      function populateServersSelect(response) {
        response.forEach(({ name, id }) => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = name;
          serversSelect.appendChild(option);
        });
      }
    </script>
  </body>
</html>

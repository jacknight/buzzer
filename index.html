<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="icon" href="favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="stylesheet" type="text/css" href="select-css.css" />

    <title>Buzzer Controls</title>
  </head>
  <body>
    <div class="layout">
      <a
        class="login-link"
        style="display: none"
        href="https://discord.com/api/oauth2/authorize?client_id=789204496097214514&permissions=67136576&redirect_uri=https%3A%2F%2Fdiscord-buzzer.herokuapp.com&response_type=token&scope=identify%20bot%20guilds"
        >Login</a
      >
      <div class="control-panel" style="display: none">
        <img src="assets/yks-logo.webp" />
        <div class="buzz-queue">
          <div class="buzz-list">
            <h1>Dookie List</h1>
            <ol></ol>
          </div>
          <button name="random">Random</button>
          <button name="clear">Clear</button>
        </div>
        <div class="buzz-controls">
          <button name="mode">Mode</button>
          <p id="mode">-</p>
          <button name="ready">&#10004;</button>
          <p id="ready">-</p>
        </div>
        <div class="buzz-servers" hidden>
          <select name="servers" id="servers" class="select-css"></select>
          <button name="serverSelect" id="serverSelect">Channels</button>
        </div>
        <div class="buzz-channels" hidden>
          <select name="channels" id="channels" class="select-css"></select>
          <button name="channelSelect" id="channelSelect">Listen</button>
        </div>
      </div>
    </div>
    <script src="node_modules/socket.io/client-dist/socket.io.js"></script>
    <script src="client.js"></script>
    <script>
      if (!localStorage.getItem("stateParameter")) {
        const randStr = generateRandomString();
        localStorage.setItem("stateParameter", randStr);
        document.querySelector(".login-link").href += `&state=${btoa(randStr)}`;
      } else {
        document.querySelector(".login-link").href += `&state=${btoa(
          localStorage.getItem("stateParameter")
        )}`;
      }

      window.onload = () => {
        const fragment = new URLSearchParams(window.location.hash.slice(1));

        if (fragment.has("access_token")) {
          const urlState = fragment.get("state");
          const stateParameter = localStorage.getItem("stateParameter");
          if (stateParameter !== atob(decodeURIComponent(urlState))) {
            return console.log("Something amiss!");
          }

          const accessToken = fragment.get("access_token");
          const tokenType = fragment.get("token_type");

          fetch("https://discord.com/api/users/@me", {
            headers: {
              authorization: `${tokenType} ${accessToken}`,
            },
          })
            .then((res) => res.json())
            .then((response) => {
              const { username, discriminator } = response;
              document.querySelector(".control-panel").style.display = "grid";
            })
            .catch(console.error);
        } else {
          document.querySelector(".login-link").style.display = " block";
        }
      };

      function generateRandomString() {
        const rand = Math.floor(Math.random() * 10);
        let randStr = "";

        for (let i = 0; i < 20 + rand; i++) {
          randStr += String.fromCharCode(33 + Math.floor(Math.random() * 94));
        }

        return randStr;
      }
    </script>
  </body>
</html>
